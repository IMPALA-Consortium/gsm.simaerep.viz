# gsm.kri Report Interactivity Documentation

## Overview

The `inst/report/lib/` folder in gsm.kri contains JavaScript files that provide interactivity to HTML reports generated by R Markdown. These scripts enable cross-chart site selection, UI controls, and enhanced user interactions.

## JavaScript Files

### 1. overallGroupDropdown.js

**Purpose:** Creates a global site/group selector that synchronizes selection across all charts in the report.

**Key Functions:**

- `overallGroupDropdown()` - Creates and populates dropdown with all available group IDs
  - Collects all group IDs from individual widget dropdowns
  - Creates unified selector at top of report
  - Eliminates duplicates across multiple charts

- `overallClick()` - Handles selection events and propagates to all widgets
  - Captures all `.gsm-widget` containers
  - Identifies chart widgets by presence of `<canvas>` elements
  - Updates each chart's `selectedGroupIDs` configuration
  - Special handling for timeSeries widgets vs other chart types
  - Resets individual widget selectors to match global selection
  - Manages country/group selector coordination

**DOM Integration:**
```javascript
document.querySelectorAll('.gsm-widget')  // Widget containers
document.querySelectorAll('.gsm-widget-control--group')  // Individual dropdowns
document.querySelectorAll('.gsm-widget-control--country')  // Country dropdowns
```

**Triggered:** DOMContentLoaded event

---

### 2. dragOverallGroupDropdown.js

**Purpose:** Makes the global group selector draggable for better UX.

**Key Functions:**

- `dragElement(elmnt)` - Enables drag-and-drop functionality
  - Mouse event handlers for drag start, move, and end
  - Position calculations using clientX/clientY coordinates
  - Updates element position with inline styles

**DOM Integration:**
```javascript
document.querySelector('.overall-group-select')  // Target element
```

**Triggered:** DOMContentLoaded event

---

### 3. toggleTOC.js

**Purpose:** Provides show/hide functionality for table of contents with responsive layout adjustments.

**Key Functions:**

- Creates fixed-position toggle button
- Toggles TOC visibility via CSS class manipulation
- Adjusts main content width dynamically (col-sm-8/12, col-md-9/12)
- Visual button state changes (color, text)

**DOM Integration:**
```javascript
document.querySelector("#TOC")  // Table of contents element
document.querySelector(".col-xs-12.col-sm-8.col-md-9")  // Main content
```

**CSS Classes Added:**
- `.hidden` - Hides TOC (display: none)

**Triggered:** DOMContentLoaded event

---

### 4. toggleTables.js

**Purpose:** Generic function for toggling between two related tables (summary vs detailed view).

**Key Functions:**

- `toggleTables(checkbox)` - Switches between two table views
  - Uses data attributes: `data-shown-table`, `data-hidden-table`
  - Updates visibility and toggle label text
  - Checkbox-driven interaction

**DOM Integration:**
```html
<input type="checkbox" 
  data-shown-table="summary-table-id" 
  data-hidden-table="detail-table-id" 
  onchange="toggleTables(this)">
<span class="toggle-label">Show Details</span>
```

**Triggered:** Manual checkbox onChange event

---

### 5. toggleChanges.js

**Purpose:** Manages collapsible/expandable flag change lists with expand/collapse all functionality.

**Key Functions:**

- Initializes nested list visibility (hidden by default)
- Auto-expands red flag sections
- Click handlers for parent/item expansion
- Expand All / Collapse All links

**DOM Structure:**
```javascript
.flag-change-parent  // Top-level items (clickable)
  .flag-change-nested  // Nested lists
.flag-change-item  // Individual items (clickable)
  .flag-change-details  // Item details
.change-expand-all  // Expand all link
.change-collapse-all  // Collapse all link
```

**CSS Classes Added:**
- `.expandable` - Item can be expanded
- `.expanded` - Item is currently expanded
- `.flag-change-expanded` - Pre-expanded by default

**Triggered:** DOMContentLoaded event

---

## Required gsm.viz Chart Interfaces

For these JavaScript files to work correctly, gsm.viz charts must implement the following interfaces:

### 1. Chart Object Structure

**Must expose:**
```javascript
canvas.chart = {
  data: {
    config: {
      selectedGroupIDs: string,  // Currently selected group ID
      // ... other config
    },
    _thresholds_: object  // Statistical thresholds
  },
  helpers: {
    updateConfig: function(chart, config, thresholds),  // Update chart config
    updateSelectedGroupIDs: function(groupID)  // For timeSeries only
  }
}
```

### 2. Canvas Element Attachment

**Charts must attach chart object to canvas:**
```javascript
const canvas = document.querySelector('canvas');
canvas.chart = chartInstance;
```

### 3. Widget Container Structure

**HTML structure for each widget:**
```html
<div class="gsm-widget">
  <canvas></canvas>  <!-- Chart canvas -->
  <select class="gsm-widget-control--group">  <!-- Group selector -->
    <option>None</option>
    <option>Site001</option>
    <!-- ... -->
  </select>
  <select class="gsm-widget-control--country">  <!-- Country selector -->
    <option>None</option>
    <option>USA</option>
    <!-- ... -->
  </select>
</div>
```

### 4. CSS Classes Required

**Widget containers:**
- `.gsm-widget` - Main widget container
- `.gsm-widget-control--group` - Group dropdown
- `.gsm-widget-control--country` - Country dropdown
- `.gsm-widget-control--select` - Any selector (group or country)

**Report structure:**
- `.overall-group-select` - Container for global selector
- `#overall-group-select` - ID for dropdown insertion point

### 5. Chart Update Methods

**Required helper methods:**

```javascript
// For most chart types (scatter, bar, etc.)
chart.helpers.updateConfig(chart, newConfig, thresholds) {
  // Update chart configuration
  // Re-render chart with new selectedGroupIDs
  // Highlight selected group
}

// For timeSeries charts (special case)
chart.helpers.updateSelectedGroupIDs(groupID) {
  // Update selected groups
  // Re-render time series
}
```

### 6. Chart Type Detection

**Charts must include type information in container className:**
```html
<div class="gsm-widget timeSeries">...</div>  <!-- For time series -->
<div class="gsm-widget scatterPlot">...</div>  <!-- For scatter plots -->
```

**Used by:**
```javascript
if (/timeSeries/.test(widget.chartType)) {
  // Special handling for time series
}
```

---

## Integration Flow

### Site Selection Process

1. User selects site in global dropdown (`overallGroupDropdown.js`)
2. `overallClick()` triggered
3. For each chart widget:
   - Get canvas element
   - Access `canvas.chart` object
   - Update `chart.data.config.selectedGroupIDs`
   - Call `chart.helpers.updateConfig()` or `updateSelectedGroupIDs()`
4. Each chart re-renders with selected site highlighted
5. Individual widget selectors sync to match global selection

### Data Flow Diagram

```
User Selection (Global Dropdown)
  ↓
overallClick() Event Handler
  ↓
Query All .gsm-widget Containers
  ↓
For Each Widget:
  - Find canvas element
  - Access canvas.chart object
  - Update chart.data.config.selectedGroupIDs
  - Call chart.helpers.updateConfig()
  ↓
Chart Re-renders with Highlight
  ↓
Individual Selectors Updated
```

---

## R Markdown Integration

### How Scripts Are Loaded

From `Report_KRI.Rmd`:

```r
# Locate script files
group_dropdown <- system.file('report', 'lib', 'overallGroupDropdown.js', package = "gsm.kri")
dropdown_drag <- system.file('report', 'lib', 'dragOverallGroupDropdown.js', package = "gsm.kri")
toggle_toc <- system.file('report', 'lib', 'toggleTOC.js', package = "gsm.kri")

# Include in HTML output
```{js, file={group_dropdown}, echo=FALSE}
```

```{js, file={dropdown_drag}, echo=FALSE}
```

```{js, file={toggle_toc}, echo=FALSE}
```

```{js, file=system.file('report', 'lib', 'toggleChanges.js', package = 'gsm.kri'), echo=FALSE}
```
```

### Global Dropdown Container

```html
::: {#overall-group-select .overall-group-select title="Selected group will be highlighted in all charts for all KRIs."}
:::
```

This creates the insertion point for the global dropdown.

---

## Implementation Requirements for gsm.simaerep.viz

To support similar interactivity, gsm.simaerep.viz charts must:

### 1. Chart Construction

```javascript
class MyChart {
  constructor(container, data, config) {
    this.container = container;
    this.canvas = document.createElement('canvas');
    this.container.appendChild(this.canvas);
    
    // CRITICAL: Attach chart instance to canvas
    this.canvas.chart = this;
    
    this.data = {
      config: {
        selectedGroupIDs: config.selectedGroupIDs || 'None',
        ...config
      },
      _thresholds_: data.thresholds
    };
    
    this.helpers = {
      updateConfig: this.updateConfig.bind(this),
      updateSelectedGroupIDs: this.updateSelectedGroupIDs.bind(this)
    };
  }
  
  updateConfig(chart, config, thresholds) {
    // Update configuration
    chart.data.config = config;
    chart.data._thresholds_ = thresholds;
    // Re-render with highlights
    this.render();
  }
  
  updateSelectedGroupIDs(groupID) {
    this.data.config.selectedGroupIDs = groupID;
    this.render();
  }
  
  render() {
    // Rendering logic with selectedGroupIDs highlighting
  }
}
```

### 2. HTML Widget Wrapper (R)

```r
Widget_MyChart <- function(dfResults, options = list()) {
  # Create container with proper classes
  container_class <- "gsm-widget myChart"
  
  # Generate widget HTML
  htmlwidgets::createWidget(
    name = 'myChart',
    x = list(
      data = dfResults,
      config = options,
      containerClass = container_class
    ),
    package = 'gsm.simaerep.viz'
  )
}
```

### 3. JavaScript Binding (htmlwidgets)

```javascript
HTMLWidgets.widget({
  name: 'myChart',
  type: 'output',
  factory: function(el, width, height) {
    return {
      renderValue: function(x) {
        // Add gsm-widget class
        el.classList.add('gsm-widget', 'myChart');
        
        // Create chart
        const chart = new MyChart(el, x.data, x.config);
        
        // Create group selector
        const select = document.createElement('select');
        select.className = 'gsm-widget-control--group';
        select.innerHTML = '<option>None</option>';
        // Add group options...
        el.appendChild(select);
        
        // Handle local selection
        select.onchange = (e) => {
          chart.updateSelectedGroupIDs(e.target.value);
        };
      }
    };
  }
});
```

---

## Key Takeaways

1. **Canvas Attachment Critical:** Charts MUST attach themselves to `canvas.chart`
2. **Standardized API:** All charts need consistent `helpers.updateConfig()` method
3. **CSS Class Contract:** Specific class names enable script discovery of widgets
4. **Group ID Propagation:** Selection flows from global → charts → individual selectors
5. **Special Cases:** TimeSeries widgets use different update method
6. **R Markdown Integration:** Scripts loaded at end of template, run on DOMContentLoaded

---

## Dependencies

### External Libraries

- **Chart.js** - Base charting library (assumed)
- **gsm.viz** - Core visualization library

### Browser APIs Used

- DOM Selection: `querySelector`, `querySelectorAll`
- Events: `addEventListener`, `onchange`, `onclick`
- Mouse Events: `onmousedown`, `onmousemove`, `onmouseup`
- Element Manipulation: `style`, `classList`, `appendChild`

### R Package Dependencies

- **htmlwidgets** - R-to-JavaScript bridge
- **knitr/rmarkdown** - Report generation
- **gt** - Table formatting

---

## Browser Compatibility

Scripts use vanilla JavaScript with good browser support:
- ES6 features: arrow functions, const/let, template literals
- Spread operator: `[...document.querySelectorAll(...)]`
- classList API
- CustomEvent (if implemented)

**Minimum:** Modern browsers (Chrome 51+, Firefox 54+, Safari 10+, Edge 15+)

